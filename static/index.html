<!DOCTYPE html>
<html>
<head>
    <title>å¤šæˆ¿é—´èŠå¤©å®¤</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    let ws;
    let currentRoom = null;
    let messageQueue = []; // æ¶ˆæ¯é˜Ÿåˆ—

    // æ˜¾ç¤ºé€‰é¡¹å¡
    function showTab(tabName) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));

        document.getElementById(tabName + 'Tab').classList.add('active');
        document.querySelector(`button[onclick="showTab('${tabName}')"]`).classList.add('active');
    }

    function showLoading() {
        document.getElementById('loading').classList.remove('hidden');
    }

    function hideLoading() {
        document.getElementById('loading').classList.add('hidden');
    }

    // ä¿®æ”¹åçš„åˆ›å»ºæˆ¿é—´å‡½æ•°
    async function createRoom() {
        showLoading();
        try {
            await initWebSocket();
            const username = document.getElementById('usernameCreate').value.trim() || 'åŒ¿åç”¨æˆ·';
            const password = document.getElementById('roomPassword').value;

            ws.send(JSON.stringify({
                type: 'create_room',
                username: username,
                password: password
            }));

        } catch (error) {
            Swal.fire('é”™è¯¯', 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        } finally {
            hideLoading();
        }
    }

    // ä¿®æ”¹åçš„åŠ å…¥æˆ¿é—´å‡½æ•°
    async function joinRoom() {
        const roomId = document.getElementById('roomId').value.trim();
        const password = document.getElementById('joinPassword').value;
        const username = document.getElementById('usernameJoin').value.trim() || 'åŒ¿åç”¨æˆ·';

        try {
            await initWebSocket(); // ç­‰å¾…è¿æ¥å»ºç«‹

            ws.send(JSON.stringify({
                type: 'join_room',
                room_id: roomId,
                password: password,
                username: username
            }));

        } catch (error) {
            Swal.fire('é”™è¯¯', 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        }
    }

    // åˆå§‹åŒ–WebSocketï¼ˆä¼˜åŒ–ç‰ˆï¼‰
    function initWebSocket() {
        return new Promise((resolve, reject) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                resolve();
                return;
            }

            ws = new WebSocket('wss://' + window.location.host + '/ws');

            ws.onopen = () => {
                while (messageQueue.length > 0) {
                    const msg = messageQueue.shift();
                    ws.send(JSON.stringify(msg));
                }
                resolve();
            };

            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                switch (msg.type) {
                    case 'system':
                        handleSystemMessage(msg.content);
                        break;
                    case 'message':
                        appendMessage(msg);
                        break;
                    case 'room_info':
                        document.getElementById('currentRoom').textContent = msg.room_id;
                        break;
                    case 'error':
                        Swal.fire('é”™è¯¯', msg.error, 'error');
                        break;
                    case 'show_chat_panel':
                        document.getElementById('roomPanel').classList.add('hidden');
                        document.getElementById('chatPanel').classList.remove('hidden');
                        break;
                    case 'show_room_panel':
                        resetUI();
                    case 'user_id': // æ–°å¢å¤„ç† userId çš„æ¶ˆæ¯ç±»å‹
                        ws.userId = msg.userId; // ä¿å­˜ userId åˆ° ws å¯¹è±¡
                        break;
                }
            };

            ws.onerror = (error) => {
                reject(error);
            };
        });
    }

    // å¤„ç†ç³»ç»Ÿæ¶ˆæ¯
    function handleSystemMessage(content) {
        if (content.startsWith('æˆ¿é—´åˆ›å»ºæˆåŠŸ')) {
            currentRoom = content.split('ID: ')[1];
            document.getElementById('currentRoom').textContent = currentRoom;
            appendSystemMessage(`æ‚¨å·²åˆ›å»ºæˆ¿é—´ ${currentRoom}`);
        } else if (content.startsWith('æˆåŠŸåŠ å…¥æˆ¿é—´')) {
            currentRoom = content.split(' ')[1]; // å‡è®¾æ¶ˆæ¯æ ¼å¼ä¸º "æˆåŠŸåŠ å…¥æˆ¿é—´ <room_id>"
            document.getElementById('currentRoom').textContent = currentRoom;
            document.getElementById('roomPanel').classList.add('hidden');
            document.getElementById('chatPanel').classList.remove('hidden');
            ws.send(JSON.stringify({
                type: 'get_users',
                room_id: currentRoom
            }));
        }else if (content.startsWith('å½“å‰æˆ¿é—´ç”¨æˆ·:')){
            document.getElementById('currentUsers').textContent = content.split(': ')[1];
            return
        }
        appendSystemMessage(content);
    }

    // ä¿®æ”¹åçš„å‘é€æ¶ˆæ¯å‡½æ•°
    function sendMessage() {
        const input = document.getElementById('messageInput');
        const content = input.value.trim();
        if (!content) return;

        const message = {
            type: 'message',
            content: content,
            from: document.getElementById('usernameCreate').value.trim() || document.getElementById('usernameJoin').value.trim(), // ç¡®ä¿æ¶ˆæ¯åŒ…å«å‘é€è€…ä¿¡æ¯
            userId: ws.userId, // æ·»åŠ å‘é€è€…çš„ userId
            timestamp: new Date().toLocaleTimeString() // æ·»åŠ æ—¶é—´æˆ³
        };

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(message));
        } else {
            messageQueue.push(message);
            if (!ws || ws.readyState === WebSocket.CLOSED) {
                initWebSocket().catch(() => {
                    Swal.fire('é”™è¯¯', 'æ­£åœ¨å°è¯•é‡æ–°è¿æ¥...', 'info');
                });
            }
        }

        input.value = '';
    }

    // ç¦»å¼€æˆ¿é—´
    function leaveRoom() {
        ws.send(JSON.stringify({ type: 'leave_room' }));
        ws.close();
        resetUI();
    }

    // é‡ç½®ç•Œé¢
    function resetUI() {
        currentRoom = null;
        document.getElementById('chatPanel').classList.add('hidden');
        document.getElementById('roomPanel').classList.remove('hidden');
        document.getElementById('messages').innerHTML = '';
    }

    // æ¶ˆæ¯å¤„ç†
    function appendMessage(msg) {
        const messages = document.getElementById('messages');
        const div = document.createElement('div');

        // æ”¹ä¸ºæ›´å¯é çš„åˆ¤æ–­æ–¹å¼
        const currentUserId = ws.userId; // ä½¿ç”¨ userId è¿›è¡Œåˆ¤æ–­
        // æ·»åŠ æ¶ˆæ¯ç±»å‹åˆ¤æ–­
        const isMe = msg.userId === currentUserId;

        div.className = `message ${isMe ? 'my-message' : 'other-message'}`;

        div.innerHTML = `
<div class="message-header">
  <span class="username">${msg.from}</span>
  <span class="timestamp">${msg.timestamp}</span>
</div>
<div class="message-content">${msg.content}</div>
`;

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    function appendSystemMessage(content) {
        const messages = document.getElementById('messages');
        const div = document.createElement('div');
        div.className = 'message system';
        div.textContent = content;
        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }

    // é”®ç›˜äº‹ä»¶
    function handleKeyPress(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            if (document.getElementById('roomPanel').classList.contains('hidden')){
                sendMessage()
                return
            }
            e.preventDefault();
            // æ ¹æ®å½“å‰æ¿€æ´»çš„é€‰é¡¹å¡è§¦å‘ç›¸åº”çš„æŒ‰é’®
            if (document.getElementById('createTab').classList.contains('active')) {
                createRoom();
            } else if (document.getElementById('joinTab').classList.contains('active')) {
                joinRoom();
            }
        }
    }

    // æ˜¾ç¤ºè¡¨æƒ…é¢æ¿
    function showEmojisPanel() {
        const emojisPanel = document.getElementById('emojisPanel');
        emojisPanel.classList.remove('hidden');
    }

    // æ’å…¥è¡¨æƒ…åˆ°æ¶ˆæ¯è¾“å…¥æ¡†
    function insertEmoji(emoji) {
        const input = document.getElementById('messageInput');
        input.value += emoji;
        input.focus();
    }

    // ç‚¹å‡»å…¶ä»–åœ°æ–¹è‡ªåŠ¨æ”¶èµ·è¡¨æƒ…é¢æ¿
    document.addEventListener('click', function(event) {
        const emojisPanel = document.getElementById('emojisPanel');
        const emojisButton = document.querySelector('button[onclick="showEmojisPanel()"]');
        if (!emojisPanel.contains(event.target) && event.target !== emojisButton) {
            emojisPanel.classList.add('hidden');
        }
    });

    // ä¿®æ”¹è¾“å…¥æ¡†æŒ‰é’®çš„ç‚¹å‡»äº‹ä»¶
    document.querySelector('button[onclick="showTab(\'emojis\')"]').setAttribute('onclick', 'showEmojisPanel()');

</script>

<div id="loading" class="hidden">
    <div class="loader"></div>
    <p>æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
</div>
<div class="container">
    <!-- æˆ¿é—´é€‰æ‹©ç•Œé¢ -->
    <div id="roomPanel" class="panel">
        <h1>æ¬¢è¿æ¥åˆ°èŠå¤©å®¤</h1>
        <div class="tabs">
            <button class="tab active" onclick="showTab('create')">åˆ›å»ºæˆ¿é—´</button>
            <button class="tab" onclick="showTab('join')">åŠ å…¥æˆ¿é—´</button>
        </div>

        <!-- åˆ›å»ºæˆ¿é—´ -->
        <div id="createTab" class="tab-content active">
            <input type="text" id="usernameCreate" placeholder="ä½ çš„æ˜µç§°">
            <input type="password" id="roomPassword" placeholder="æˆ¿é—´å¯†ç ï¼ˆå¯é€‰ï¼‰">
            <button onclick="createRoom()">åˆ›å»ºæ–°æˆ¿é—´</button>
        </div>

        <!-- åŠ å…¥æˆ¿é—´ -->
        <div id="joinTab" class="tab-content">
            <input type="text" id="usernameJoin" placeholder="ä½ çš„æ˜µç§°">
            <input type="text" id="roomId" placeholder="æˆ¿é—´IDï¼ˆ4ä½éšæœºå­—ç¬¦ï¼‰" maxlength="4">
            <input type="password" id="joinPassword" placeholder="æˆ¿é—´å¯†ç ï¼ˆå¦‚æœæœ‰ï¼‰">
            <button onclick="joinRoom()">åŠ å…¥æˆ¿é—´</button>
        </div>
    </div>

    <!-- èŠå¤©ç•Œé¢ -->
    <div id="chatPanel" class="panel hidden">
        <div class="room-info">
            <span>æˆ¿é—´ID: <span id="currentRoom">----</span></span>
            <span>å½“å‰ç”¨æˆ·: <span id="currentUsers">----</span></span>
            <button onclick="leaveRoom()">åˆ‡æ¢æˆ¿é—´</button>
        </div>

        <div id="messages"></div>

        <div class="input-group">
            <input type="text" id="messageInput"
                   placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒæŒ‰Enterå‘é€"
                   onkeydown="handleKeyPress(event)">
            <button onclick="sendMessage()">å‘é€</button>
            <button onclick="showEmojisPanel()">è¡¨æƒ…</button>
        </div>
    </div>

    <!-- è¡¨æƒ…é€‰æ‹©é¢æ¿ -->
    <div id="emojisPanel" class="hidden">
        <div class="emoji-list">
            <button onclick="insertEmoji('ğŸ˜Š')">ğŸ˜Š</button>
            <button onclick="insertEmoji('ğŸ˜‚')">ğŸ˜‚</button>
            <button onclick="insertEmoji('ğŸ˜')">ğŸ˜</button>
            <button onclick="insertEmoji('ğŸ˜')">ğŸ˜</button>
            <button onclick="insertEmoji('ğŸ˜¢')">ğŸ˜¢</button>
            <button onclick="insertEmoji('ğŸ˜­')">ğŸ˜­</button>
            <button onclick="insertEmoji('ğŸ¤”')">ğŸ¤”</button>
            <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
            <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
            <button onclick="insertEmoji('ğŸ‘')">ğŸ‘</button>
            <button onclick="insertEmoji('ğŸ™Œ')">ğŸ™Œ</button>
            <button onclick="insertEmoji('ğŸ‘‹')">ğŸ‘‹</button>
        </div>
    </div>
</div>

</body>
</html>